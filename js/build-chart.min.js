import{getSeriesChartWidth}from"./deter-amazon-aggregated-utils.js";export function build(context){let chartReferencies=setChartReferencies();buildCompositeChart(context),buildSeriesChart(),chartReferencies.ringTotalizedByState.height(defaultHeight).innerRadius(10).externalRadiusPadding(30).dimension(ufDimension).group(ufGroup).title((function(d){var v=Math.abs(+parseFloat(d.value).toFixed(2));return v=localeBR.numberFormat(",1f")(v),Translation[Lang.language].area+": "+v+" "+Translation[Lang.language].unit})).label((function(d){var v=Math.abs(+parseFloat(d.value).toFixed(0));return v=localeBR.numberFormat(",1f")(v),d.key+":"+v+" "+Translation[Lang.language].unit})).ordering(dc.pluck("key")).ordinalColors(graph.ringPallet).legend(dc.legend().x(20).y(10).itemHeight(13).gap(7).horizontal(0).legendWidth(50).itemWidth(35)),chartReferencies.ringTotalizedByState.valueAccessor((function(d){return Math.abs(+d.value.toFixed(2))})),rowTotalizedByClass.height(defaultHeight).dimension(classDimension).group(utils.snapToZero(classGroup)).title((function(d){var v=Math.abs(+parseFloat(d.value).toFixed(2));v=localeBR.numberFormat(",1f")(v);var t=Translation[Lang.language].area+": "+v+" "+Translation[Lang.language].unit;return"CORTE_SELETIVO"===d.key&&(t=Translation[Lang.language].area+": "+v+" "+Translation[Lang.language].unit+" ("+("prodes"==graph.calendarConfiguration?Translation[Lang.language].warning_class_prodes:Translation[Lang.language].warning_class)+")"),t})).label((function(d){var v=Math.abs(+parseFloat(d.value).toFixed(1));v=localeBR.numberFormat(",1f")(v);var t=utils.mappingClassNames(d.key)+": "+v+" "+Translation[Lang.language].unit;return"CORTE_SELETIVO"===d.key&&(t=utils.mappingClassNames(d.key)+"*: "+v+" "+Translation[Lang.language].unit+" ("+("prodes"==graph.calendarConfiguration?Translation[Lang.language].warning_class_prodes:Translation[Lang.language].warning_class)+")"),t})).elasticX(!0).ordinalColors(["#FF0000","#FFFF00","#FF00FF","#F8B700","#78CC00","#00FFFF","#56B2EA","#0000FF","#00FF00"]).ordering((function(d){return-d.value})).controlsUseVisibility(!0),rowTotalizedByClass.xAxis().tickFormat((function(d){var t=parseInt(d/1e3);return t=t<1?parseInt(d):t+"k"})).ticks(5),rowTotalizedByClass.filterPrinter((function(f){var l=[];return f.forEach((function(cl){l.push(utils.mappingClassNames(cl))})),l.join(",")}));let barColors=getOrdinalColorsToYears(graph.defPallet);barAreaByYear.height(defaultHeight).yAxisLabel(Translation[Lang.language].area+" ("+Translation[Lang.language].unit+")").xAxisLabel("prodes"==graph.calendarConfiguration?Translation[Lang.language].barArea_x_label_prodes:Translation[Lang.language].barArea_x_label).dimension(yearDimension).group(utils.snapToZero(yearGroup)).title((function(d){var v=Math.abs(+parseFloat(d.value).toFixed(2));return v=localeBR.numberFormat(",1f")(v),Translation[Lang.language].area+": "+v+" "+Translation[Lang.language].unit})).label((function(d){var v=Math.abs(+parseFloat(d.data.value).toFixed(0));return v=localeBR.numberFormat(",1f")(v)})).elasticY(!0).yAxisPadding("10%").x(d3.scale.ordinal()).xUnits(dc.units.ordinal).barPadding(.2).outerPadding(.1).renderHorizontalGridLines(!0).colorCalculator((function(d){for(var i=0,l=barColors.length;i<l;){if(barColors[i].key==d.key)return barColors[i].color;i++}})).margins({top:20,right:35,bottom:"prodes"==graph.calendarConfiguration?75:60,left:55}),barAreaByYear.on("renderlet.a",(function(chart){"prodes"==graph.calendarConfiguration?chart.selectAll("g.x text").attr("transform","translate(-25,18) rotate(315)"):chart.selectAll("g.x text").attr("transform","translate(-15,8) rotate(315)")})),dc.chartRegistry.list("filtra").forEach((function(c,i){c.on("filtered",(function(chart,filter){var filters=chart.filters(),commonFilterFunction=function(d){for(var i=0;i<filters.length;i++){var f=filters[i];if(f.isFiltered&&f.isFiltered(d))return!0;if(f<=d&&f>=d)return!0}return!1};if("chart-by-year"==chart.anchorName()&&(filters.length?(graph.yearDimension0.filterFunction(commonFilterFunction),graph.yearDimensionCloud.filterFunction(commonFilterFunction)):(graph.yearDimension0.filterAll(),graph.yearDimensionCloud.filterAll())),"chart-by-state"==chart.anchorName()&&(filters.length?(graph.ufDimension0.filterFunction(commonFilterFunction),graph.ufDimensionCloud.filterFunction(commonFilterFunction)):(graph.ufDimension0.filterAll(),graph.ufDimensionCloud.filterAll())),"chart-by-class"==chart.anchorName())if(filters.length){var eqDef=!0,eqDeg=!0;filters.forEach(f=>{graph.deforestation.includes(f)||(eqDef=!1),graph.degradation.includes(f)||(eqDeg=!1)}),eqDef=!!eqDef&&filters.length==graph.deforestation.length,eqDeg=!!eqDeg&&filters.length==graph.degradation.length,eqDef&&!eqDeg?utils.highlightClassFilterButtons("deforestation"):!eqDef&&eqDeg?utils.highlightClassFilterButtons("degradation"):utils.highlightClassFilterButtons("custom"),graph.classDimension0.filterFunction(commonFilterFunction)}else graph.classDimension0.filterAll();dc.redrawAll("agrega"),graph.displayCustomValues()}))})),utils.renderAll(),graph.filterByClassGroup("deforestation"),utils.attachListenersToLegend()}function buildCompositeChart(context){context.lineSeriesMonthly=dc.compositeChart("#agreg","agrega");let legendItemWidth=80,legendWidth=80*context.yearGroup0.all().length;legendWidth=legendWidth<getSeriesChartWidth()?+legendWidth.toFixed(0):getSeriesChartWidth();let fxDomain=d3.scale.linear().domain("prodes"==context.calendarConfiguration?[7,20]:[0,13]);context.lineSeriesMonthly.height(context.defaultHeight).x(fxDomain).renderHorizontalGridLines(!0).renderVerticalGridLines(!0).brushOn(!1).yAxisLabel(Translation[Lang.language].mainbar_y_label).rightYAxisLabel(Translation[Lang.language].clouds_y_label).elasticY(!0).shareTitle(!1).yAxisPadding("10%").clipPadding(10).legend(dc.legend().x(100).y(10).itemHeight(13).gap(5).horizontal(1).legendWidth(legendWidth).itemWidth(80)).margins({top:40,right:65,bottom:30,left:65}).compose(composeCharts(context)),context.lineSeriesMonthly.xAxis().tickFormat((function(d){return utils.xaxis(d)})),context.lineSeriesMonthly.on("renderlet.a",c=>{utils.moveBars(c),utils.makeMonthsChooserList(),utils.highlightSelectedMonths()}).on("pretransition",c=>{const svg=c.select("svg");svg.selectAll("rect.bar").attr("class","bar bar1");let legItens={};c.selectAll(".dc-legend-item")[0].forEach(it=>{let i=it.textContent.trim();if(legItens[i]){let p1=legItens[i].split(","),p2=it.getAttribute("transform").split(",");it.setAttribute("transform",p1[0]+","+p2[1])}else legItens[i]=it.getAttribute("transform")})}).on("preRedraw",(function(c){c.rescale()})).on("preRender",(function(c){c.rescale()})),context.lineSeriesMonthly.rightYAxis().tickFormat(a=>a+"%"),context.lineSeriesMonthly.on("filtered",(function(c){if(c.filter()){let fn=d=>graph.monthFilters.includes(d);graph.monthDimension.filterFunction(fn),graph.monthDimension0.filterFunction(fn),graph.monthDimensionCloud.filterFunction(fn),dc.redrawAll("filtra"),graph.displayCustomValues()}}))}function buildSeriesChart(context){context.lineSeriesMonthly=dc.seriesChart("#agreg","agrega");let fcDomain=d3.scale.linear().domain("prodes"==graph.calendarConfiguration?[8,19]:[1,12]);context.lineSeriesMonthly.height(context.defaultHeight-70).chart((function(c){return dc.lineChart(c).renderDataPoints(!0).evadeDomainFilter(!0)})).x(fcDomain).renderHorizontalGridLines(!0).renderVerticalGridLines(!0).brushOn(!1).yAxisLabel(Translation[Lang.language].mainbar_y_label).elasticY(!0).yAxisPadding("10%").clipPadding(10).dimension(context.temporalDimension0).group(context.areaGroup0).title((function(d){var v=Math.abs(+parseFloat(d.value).toFixed(2));return v=localeBR.numberFormat(",1f")(v),utils.xaxis(d.key[1])+" - "+d.key[0]+"\n"+Translation[Lang.language].area+" "+v+" "+Translation[Lang.language].unit})).seriesAccessor((function(d){return d.key[0]})).keyAccessor((function(d){return d.key[1]})).valueAccessor((function(d){return graph.lineSeriesMonthly.hasFilter()?graph.monthFilters.indexOf(d.key[1])>=0?Math.abs(+d.value.toFixed(2)):0:Math.abs(+d.value.toFixed(2))})).legend(dc.legend().x(100).y(30).itemHeight(15).gap(5).horizontal(1).legendWidth(600).itemWidth(80)).margins({top:20,right:35,bottom:30,left:65}),context.lineSeriesMonthly.yAxis().tickFormat((function(d){return localeBR.numberFormat(",1f")(d)})),context.lineSeriesMonthly.xAxis().tickFormat((function(d){return utils.xaxis(d)})),context.lineSeriesMonthly.on("filtered",(function(c){c.filter()&&(graph.monthDimension.filterFunction(d=>graph.monthFilters.includes(d)),graph.temporalDimension0.filterFunction(d=>graph.monthFilters.includes(d[1])),dc.redrawAll("filtra"))})),lineSeriesRenderlet(context);let barColors=getOrdinalColorsToYears(context,graph.defPallet);context.lineSeriesMonthly.colorAccessor((function(d){for(var i=0,l=barColors.length;i<l;){if(barColors[i].key==d.key)return barColors[i].color;i++}}))}function setChartReferencies(){let totalizedDeforestationArea,totalizedDegradationArea,totalizedAlertsInfoBox,totalizedCustomArea,ringTotalizedByState,rowTotalizedByClass,barAreaByYear;return{totalizedDeforestationArea:dc.numberDisplay("#deforestation-classes","agrega"),totalizedDegradationArea:dc.numberDisplay("#degradation-classes","agrega"),totalizedAlertsInfoBox:dc.numberDisplay("#numpolygons","agrega"),totalizedCustomArea:d3.select("#custom-classes"),ringTotalizedByState:dc.pieChart("#chart-by-state","filtra"),rowTotalizedByClass:dc.rowChart("#chart-by-class","filtra"),barAreaByYear:dc.barChart("#chart-by-year","filtra")}}function makeAreaGroup(dim,year){let grouped=dim.group().reduceSum(value=>value.year==year?value.area:0);return grouped.all().sort((a,b)=>a.key-b.key),grouped}function makePercentGroup(dim,d){let grouped=dim.group().reduceSum(value=>value.year==d.key?value.a:0);return g.all().sort((a,b)=>a.key-b.key),g}function composeCharts(context){let charts=[];context._cloudSubCharts=[],context._deforestationSubCharts=[];let defColors=getOrdinalColorsToYears(context,context.defPallet);context.yearGroup0.all().forEach(d=>{let colors=[];defColors.some(c=>{d.key==c.key&&colors.push(c.color)});let deterGroupByYear=makeAreaGroup(context.monthDimension0,d.key),l=makeChartBar(context.lineSeriesMonthly,context.monthDimension0,deterGroupByYear,d.key,colors,!1);graph._deforestationStatus&&charts.push(l),context._deforestationSubCharts.push(l)});let cldColors=getOrdinalColorsToYears(context,context.cldPallet);return context.yearGroupCloud.all().forEach(d=>{let colors=[];cldColors.some(c=>{d.key==c.key&&colors.push(c.color)});let cloudGroupByYear=makePercentGroup(context.monthDimensionCloud,d),l=makeChartLine(context.lineSeriesMonthly,context.monthDimensionCloud,cloudGroupByYear,d.key,colors,!0);graph._cloudStatus&&charts.push(l),context._cloudSubCharts.push(l)}),charts}let makeChartLine=(mainChart,dim,group,groupName,colors,isCloud)=>{let gn=groupName+(isCloud?" ":""),l;return dc.lineChart(mainChart).dimension(dim).group(group,gn).colorCalculator(()=>colors[0]).renderDataPoints({radius:5,fillOpacity:.8,strokeOpacity:.9}).title(v=>{let v1=Math.abs(+parseFloat(100*v.value/graph.areaUfGroupCloud.top(1)[0].value).toFixed(2));return v1=localeBR.numberFormat(",1f")(v1),utils.xaxis(v.key)+" - "+gn+"\n"+(isCloud?Translation[Lang.language].percentage+" "+v1+"%":Translation[Lang.language].area+" "+v1+Translation[Lang.language].unit)}).keyAccessor((function(k){return k.key})).valueAccessor((function(dd){return mainChart.hasFilter()?graph.monthFilters.indexOf(dd.key)>=0?+(100*dd.value/graph.areaUfGroupCloud.top(1)[0].value).toFixed(2):0:+(100*dd.value/graph.areaUfGroupCloud.top(1)[0].value).toFixed(2)})).useRightYAxis(isCloud)};function makeChartBar(mainChart,dim,group,groupName,colors,isCloud){let gn=groupName+(isCloud?" ":""),l;return dc.barChart(mainChart).dimension(dim).group(group,gn).colorCalculator(()=>colors[0]).title(v=>{let v1=Math.abs(+parseFloat(v.value).toFixed(2));return v1=localeBR.numberFormat(",1f")(v1),utils.xaxis(v.key)+" - "+gn+"\n"+(isCloud?Translation[Lang.language].percentage+" "+v1+"%":Translation[Lang.language].area+" "+v1+Translation[Lang.language].unit)}).keyAccessor((function(k){return k.key})).valueAccessor((function(dd){return mainChart.hasFilter()?graph.monthFilters.indexOf(dd.key)>=0?+dd.value.toFixed(2):0:+dd.value.toFixed(2)}))}function lineSeriesRenderlet(context){context.lineSeriesMonthly.on("renderlet",(function(c){utils.attachListenersToLegend(),graph.displayCustomValues(),dc.redrawAll("filtra");var years=[];if(graph.barAreaByYear.hasFilter()?years=graph.barAreaByYear.filters():graph.barAreaByYear.group().all().forEach(d=>{years.push(d.key)}),c.hasFilter()){if(graph.monthDimension0){graph.monthFilters=graph.monthFilters.sort((function(a,b){return a-b}));var fp="",allData=graph.monthDimension0.group().all();graph.monthFilters.forEach(monthNumber=>{var ys=[];allData.some(d=>{years.forEach(year=>{if(d.key==monthNumber)return ys.includes(year)||ys.push(year),!0})}),ys.length&&(fp+=(""==fp?"":", ")+utils.monthYearList(monthNumber,utils.nameMonthsById(monthNumber),ys))}),$("#txt18").css("display",""),$("#txt8b").html(Translation[Lang.language].someMonths),$("#highlight-time").html("&nbsp;"+fp)}}else $("#txt18").css("display","none"),$("#txt8b").html(Translation[Lang.language].allTime),$("#highlight-time").html("&nbsp;"+years.join(", "))}))}function getYears(context){return context.yearDimension.group().all()}function getRangeYears(context){for(var ys=getYears(context),l=ys.length,y=[],i=0;i<l;i++)y.push(ys[i].key);return y}function getOrdinalColorsToYears(context,colorList){for(var c=[],ys=getRangeYears(context),i=0;i<ys.length;i++)c.push({key:ys[i],color:colorList[i]});return c}